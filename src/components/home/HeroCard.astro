---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import bgImage from "@/assets/background.svg";

interface Props {
  imageUrl: ImageMetadata;
  title?: string;
  link?: string;
}

const { imageUrl, title = "Home", link = "" } = Astro.props;

const bgImageUrl = bgImage.src;
---

<div class="relative z-20 w-full dev-hero-card" data-href={link}>
  <div
    class="dev-case relative w-full h-full p-3 border-3 border-solid border-primary dark:border-primary"
  >
    <div
      class="case-square absolute top-[-5px] left-[-5px] border-2 border-solid border-primary dark:border-primary"
    >
    </div>
    <div
      class="case-square absolute top-[-5px] right-[-5px] border-2 border-solid border-primary dark:border-primary"
    >
    </div>
    <div
      class="case-square absolute bottom-[-5px] left-[-5px] border-2 border-solid border-primary dark:border-primary"
    >
    </div>
    <div
      class="case-square absolute bottom-[-5px] right-[-5px] border-2 border-solid border-primary dark:border-primary"
    >
    </div>

    <div class="relative z-20 w-full">
      <div
        class="relative top-0 left-0 w-full aspect-6/7 overflow-hidden rounded-xl case-go"
      >
        <div
          class="absolute inset-0 bg-cover bg-center bg-no-repeat blur-3xl scale-110"
          style={{ backgroundImage: `url(${bgImageUrl})` }}
        >
        </div>
        <Image
          src={imageUrl}
          alt={title}
          loading="eager"
          decoding="async"
          class="absolute top-0 left-0 right-0 z-30 w-full mx-auto object-cover h-full"
        />
      </div>
    </div>
  </div>

  <!-- Code Editor SVG -->
  <div
    class="code-editor absolute left-[-20px] top-[40%] z-30 pointer-events-none"
  >
    <svg
      width="220"
      height="120"
      viewBox="0 0 220 120"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
      class="w-full h-auto drop-shadow-xl"
    >
      <rect
        width="220"
        height="120"
        rx="8"
        fill="#1E293B"
        class="dark:fill-[#0F172A]"></rect>
      <rect
        x="0"
        y="0"
        width="220"
        height="32"
        rx="8"
        fill="#334155"
        class="dark:fill-[#1E293B]"></rect>
      <!-- Window Controls -->
      <circle cx="16" cy="16" r="4" fill="#FF5F56"></circle>
      <circle cx="30" cy="16" r="4" fill="#FFBD2E"></circle>
      <circle cx="44" cy="16" r="4" fill="#27C93F"></circle>
      <!-- Code Lines -->
      <rect x="16" y="48" width="80" height="8" rx="4" fill="#60A5FA"></rect>
      <rect x="104" y="48" width="60" height="8" rx="4" fill="#94A3B8"></rect>
      <rect x="16" y="68" width="40" height="8" rx="4" fill="#F472B6"></rect>
      <rect x="64" y="68" width="90" height="8" rx="4" fill="#94A3B8"></rect>
      <rect x="16" y="88" width="120" height="8" rx="4" fill="#94A3B8"></rect>
    </svg>
  </div>

  <!-- Terminal SVG -->
  <div
    class="terminal absolute right-[-30px] top-[65%] z-30 pointer-events-none"
  >
    <svg
      width="240"
      height="80"
      viewBox="0 0 240 80"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
      class="w-full h-auto drop-shadow-xl"
    >
      <rect width="240" height="80" rx="8" fill="#000000" fill-opacity="0.8"
      ></rect>
      <path
        d="M16 20L24 28L16 36"
        stroke="#4ADE80"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"></path>
      <rect
        x="32"
        y="24"
        width="8"
        height="12"
        fill="#4ADE80"
        class="animate-pulse"></rect>
      <rect x="32" y="48" width="120" height="6" rx="3" fill="#334155"></rect>
      <text x="44" y="34" fill="#E2E8F0" font-family="monospace" font-size="12"
        >npm run dev</text
      >
      <text x="16" y="60" fill="#94A3B8" font-family="monospace" font-size="10"
        >ready in 200ms</text
      >
    </svg>
  </div>

  {
    title && (
      <div class="absolute left-[32px] text-center top-[-22px] h-[22px] leading-[22px] w-auto px-3 overflow-hidden rounded-tl-[6px] rounded-tr-[6px] bg-primary dark:bg-primary">
        <p class="text-[11px] font-normal text-center text-white">{title}</p>
      </div>
    )
  }

  <div class="cursor-indicator">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="28"
      height="28"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="arrow-icon"
    >
      <line x1="7" y1="17" x2="17" y2="7"></line>
      <polyline points="7 7 17 7 17 17"></polyline>
    </svg>
  </div>
</div>

<style>
  .code-editor {
    /* box-shadow: -2px 4px 12px rgba(81, 74, 163, 0.1); */
    max-width: 45%;
  }

  .terminal {
    /* box-shadow: -2px 4px 12px rgba(81, 74, 163, 0.1); */
    max-width: 55%;
  }

  .case-square {
    background: #fff;
    height: 12px;
    width: 12px;
  }

  /* Add styles for parallax effect */
  .dev-case,
  .code-editor,
  .terminal {
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    will-change: transform;
  }

  /* Hover style */
  .case-go {
    position: relative;
    cursor: pointer; /* Default use pointer style */
  }

  /* When custom cursor is active, hide default mouse */
  .case-go.cursor-active {
    cursor: none !important;
  }

  /* Use global style to hide default mouse */
  html.cursor-hidden .case-go {
    cursor: none !important;
  }

  .cursor-indicator {
    position: absolute; /* Relative to parent container */
    top: 0;
    left: 0;
    background-color: white;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 3px 15px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transform: translate(-50%, -50%) scale(0.5);
    transition:
      opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1),
      transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .arrow-icon {
    color: var(--color-primary);
    width: 24px;
    height: 24px;
  }

  /* Limit the maximum movement range of parallax effect */
  @media (min-width: 1400px) {
    .dev-hero-card {
      overflow: visible; /* Allow parallax effect to exceed container */
      max-width: 100%;
    }
  }
  @media (min-width: 960px) {
    .dev-hero-card {
      overflow: visible; /* Allow parallax effect to exceed container */
      max-width: 90%;
    }
  }
  @media (min-width: 768px) {
    .dev-hero-card {
      overflow: visible; /* Allow parallax effect to exceed container */
      max-width: 100%;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Scope to each card instance if there are multiple, but here we assume one or loop
    const cards = document.querySelectorAll(".dev-hero-card");

    cards.forEach((card) => {
      const devCase = card.querySelector<HTMLElement>(".dev-case");
      const codeEditor = card.querySelector<HTMLElement>(".code-editor");
      const terminal = card.querySelector<HTMLElement>(".terminal");
      const cursorIndicator =
        card.querySelector<HTMLElement>(".cursor-indicator");
      const caseGo = card.querySelector<HTMLElement>(".case-go");
      const html = document.documentElement;

      // Check if on mobile device
      const isMobile = window.innerWidth < 768;

      // If on mobile device, do not enable parallax and custom cursor effect
      if (isMobile) {
        return;
      }

      // Strength coefficient of parallax effect
      const devCaseStrength = 25;
      const codeEditorStrength = 40;
      const terminalStrength = 50;

      // Global variables, used to store mouse position and animation state
      let mouseX = 0;
      let mouseY = 0;
      let targetX = 0;
      let targetY = 0;
      let cursorX = 0;
      let cursorY = 0;
      let isHovering = false;

      // Smooth follow interpolation coefficient
      const cursorEasing = 0.12;
      const parallaxEasing = 0.08;

      // Listen for global mouse movement - parallax effect
      document.addEventListener("mousemove", (e) => {
        // Get the position relative to the viewport center (normalized to -0.5 ~ 0.5)
        mouseX = e.clientX / window.innerWidth - 0.5;
        mouseY = e.clientY / window.innerHeight - 0.5;
      });

      // Handle mouse events for clickable areas separately - custom cursor
      if (caseGo) {
        // Mouse enters clickable area
        caseGo.addEventListener("mouseenter", () => {
          isHovering = true;
          html.classList.add("cursor-hidden");
          if (cursorIndicator) {
            cursorIndicator.style.opacity = "1";
            cursorIndicator.style.transform = "translate(-50%, -50%) scale(1)";
          }
        });

        // Mouse leaves clickable area
        caseGo.addEventListener("mouseleave", () => {
          isHovering = false;
          html.classList.remove("cursor-hidden");
          if (cursorIndicator) {
            cursorIndicator.style.opacity = "0";
            cursorIndicator.style.transform =
              "translate(-50%, -50%) scale(0.5)";
          }
        });

        // Mouse moves in clickable area
        caseGo.addEventListener("mousemove", (e: MouseEvent) => {
          if (!isHovering) return;

          // Get the position relative to the clickable area
          const rect = caseGo.getBoundingClientRect();
          targetX = e.clientX - rect.left;
          targetY = e.clientY - rect.top;
        });

        // Click event
        caseGo.addEventListener("click", () => {
          const href = card.getAttribute("data-href");
          if (href) {
            window.open(href, "_blank");
          }
        });
      }

      // Separate animation loop - parallax effect
      function updateParallax() {
        // Update parallax effect of main card
        if (devCase) {
          const targetDevCaseX = mouseX * devCaseStrength;
          const targetDevCaseY = mouseY * devCaseStrength;

          // Get current transformation matrix
          const currentTransform = new DOMMatrix(
            getComputedStyle(devCase).transform
          );
          const currentX = currentTransform.m41 || 0;
          const currentY = currentTransform.m42 || 0;

          // Smooth transition
          const newX = currentX + (targetDevCaseX - currentX) * parallaxEasing;
          const newY = currentY + (targetDevCaseY - currentY) * parallaxEasing;

          devCase.style.transform = `translate3d(${newX}px, ${newY}px, 0)`;
        }

        // Update parallax effect of code editor
        if (codeEditor) {
          const targetCodeEditorX = mouseX * codeEditorStrength;
          const targetCodeEditorY = mouseY * codeEditorStrength;

          const currentTransform = new DOMMatrix(
            getComputedStyle(codeEditor).transform
          );
          const currentX = currentTransform.m41 || 0;
          const currentY = currentTransform.m42 || 0;

          const newX =
            currentX + (targetCodeEditorX - currentX) * parallaxEasing;
          const newY =
            currentY + (targetCodeEditorY - currentY) * parallaxEasing;

          codeEditor.style.transform = `translate3d(${newX}px, ${newY}px, 0)`;
        }

        // Update parallax effect of terminal
        if (terminal) {
          const targetTerminalX = mouseX * terminalStrength;
          const targetTerminalY = mouseY * terminalStrength;

          const currentTransform = new DOMMatrix(
            getComputedStyle(terminal).transform
          );
          const currentX = currentTransform.m41 || 0;
          const currentY = currentTransform.m42 || 0;

          const newX = currentX + (targetTerminalX - currentX) * parallaxEasing;
          const newY = currentY + (targetTerminalY - currentY) * parallaxEasing;

          terminal.style.transform = `translate3d(${newX}px, ${newY}px, 0)`;
        }

        requestAnimationFrame(updateParallax);
      }

      // Separate animation loop - custom cursor
      function updateCursor() {
        if (isHovering && cursorIndicator) {
          // Smooth follow
          cursorX += (targetX - cursorX) * cursorEasing;
          cursorY += (targetY - cursorY) * cursorEasing;

          cursorIndicator.style.left = `${cursorX}px`;
          cursorIndicator.style.top = `${cursorY}px`;
        }

        requestAnimationFrame(updateCursor);
      }

      // Start two separate animation loops
      updateParallax();
      updateCursor();
    });
  });
</script>
